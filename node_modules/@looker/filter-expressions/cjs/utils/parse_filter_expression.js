"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.parseFilterExpression = void 0;

var _pegjs = require("pegjs");

var _get_matches_advanced_node = require("./get_matches_advanced_node");

var _transform_ast = require("./transform/transform_ast");

var _userAttributeTransform = require("./transform/userAttributeTransform");

var _type_to_grammar = require("./type_to_grammar");

const generateParser = (() => {
  const parserCache = {};
  return (type, grammar) => {
    if (!parserCache[type]) {
      parserCache[type] = (0, _pegjs.generate)(grammar);
    }

    return parserCache[type];
  };
})();

const parseFilterExpression = (type, expression, userAttributes) => {
  const _typeToGrammar = (0, _type_to_grammar.typeToGrammar)(type),
        grammar = _typeToGrammar.grammar,
        anyvalue = _typeToGrammar.anyvalue,
        _typeToGrammar$transf = _typeToGrammar.transform,
        transform = _typeToGrammar$transf === void 0 ? root => root : _typeToGrammar$transf;

  if (expression === '') {
    return anyvalue;
  }

  try {
    const parser = generateParser(type, grammar);
    const transforms = [(0, _userAttributeTransform.userAttributeTransform)(userAttributes), transform];
    return (0, _transform_ast.transformAST)(parser.parse(expression, {
      Object
    }), transforms);
  } catch (error) {
    return (0, _get_matches_advanced_node.getMatchesAdvancedNode)(expression);
  }
};

exports.parseFilterExpression = parseFilterExpression;
//# sourceMappingURL=parse_filter_expression.js.map